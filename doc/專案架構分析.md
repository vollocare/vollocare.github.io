# 專案架構分析

## 專案概述

這是一個基於 **p5.js** 的群體行為模擬專案，展示了**群聚算法（Flocking）**和**速度障礙（Velocity Obstacles）**的實現。專案透過視覺化的方式展示了群體 AI 的行為模式，包括群體移動、障礙物迴避、單位間的戰鬥等功能。

## 技術架構

### 1. 渲染層

- **框架選擇**：使用 p5.js 的 WebGL 模式進行 3D 渲染
- **相機系統**：實現了自定義的視窗（viewport）系統，支援 WASD 鍵控制相機移動
- **文字渲染**：使用 `TextWithViewPort` 類別，可在 3D 空間中正確顯示文字資訊

### 2. 遊戲邏輯層

專案採用**物件導向設計**，主要類別架構如下：

#### UnitObj（個體單位）
個體單位是整個系統的基礎單元，每個單位都是獨立的智能體。

**基礎屬性**：
- 位置（position）、速度（velocity）、加速度（acceleration）
- 健康值（health）、生命值（life）
- 半徑大小（與健康值相關）

**狀態機系統**：
- `move`：移動到指定目標
- `stop`：停止不動
- `follow`：跟隨領導者
- `attack`：攻擊敵人
- `escape`：逃離威脅
- `die`：死亡狀態

**攻擊系統**：
- 攻擊視野範圍：120 像素
- 有效攻擊距離：60 像素
- 攻擊冷卻時間：30 幀
- 攻擊特效顯示

#### GupUnitObj（群組管理）
管理一組單位的集體行為。

**核心功能**：
- 管理一個領導者（Leader）和多個跟隨者
- 領導者負責決定群組的移動目標
- 自動處理敵人偵測和攻擊目標分配
- 支援 PVP 模式下的自動戰鬥

#### Flock（群聚算法）
實現經典的群聚行為算法。

**三大核心行為**：
1. **Separation（分離）**：避免單位之間過度擁擠
2. **Alignment（對齊）**：與鄰近單位保持相同的移動方向
3. **Cohesion（凝聚）**：向群體中心靠攏

**額外功能**：
- 障礙物迴避（白色箭頭顯示迴避力方向）
- 敵人迴避（紫色箭頭顯示迴避力方向）
- 根據單位狀態調整行為權重

#### Obstacles（障礙物系統）
- 管理場景中的圓形障礙物
- 提供碰撞檢測接口
- 支援動態添加障礙物

#### Patrol（巡邏系統）
- 管理預設的巡邏點
- 自動分配群組到不同的巡邏路線
- 循環巡邏機制

## 遊戲機制

### 1. 控制系統

**三種控制模式**：
- 玩家控制（P1）：藍色單位
- 敵人控制1（P2）：紅色單位
- 敵人控制2（P3）：綠色單位

**操作方式**：
- 滑鼠點擊：為當前控制的群組設定移動目標
- WASD 鍵：控制視窗移動
- UI 按鈕：切換各種功能

### 2. 視覺化選項

- **Arrow（箭頭顯示）**：顯示單位受到的避障力方向
- **Target（目標線）**：顯示單位到目標點的連線
- **Stats（狀態顯示）**：顯示單位的健康值等資訊

### 3. 單位行為邏輯

**生命週期管理**：
- 每個單位初始生命值：2880 幀（約 2 分鐘）
- 生命值歸零後單位消失

**健康系統**：
- 初始健康值：12
- 健康值影響單位大小：半徑 = 健康值/3 + 基礎半徑
- 具有健康回復機制

**攻擊機制**：
- 自動搜尋視野內最近的敵人
- 進入攻擊範圍後自動攻擊
- 攻擊有冷卻時間限制
- 攻擊時顯示特效

## 程式流程

### 1. 初始化階段（setup）

1. 創建 1024x640 的 WebGL 畫布
2. 初始化相機和視窗系統
3. 創建 9 個群組，每組有一個領導者
4. 生成 11 個預設障礙物
5. 設定 6 個巡邏點
6. 創建 UI 控制按鈕

### 2. 主循環（draw）

每幀執行的更新流程：
1. 處理鍵盤輸入（WASD 移動視窗）
2. 處理滑鼠輸入（設定移動目標）
3. 更新所有群組的狀態
4. 執行群聚算法計算
5. 更新單位位置和狀態
6. 渲染所有物件
7. 處理 PVP 模式邏輯

### 3. 互動處理

**滑鼠互動**：
- 左鍵點擊：為當前控制的群組設定新的移動目標
- 拖曳：連續更新移動目標

**鍵盤控制**：
- W：向上移動視窗
- S：向下移動視窗
- A：向左移動視窗
- D：向右移動視窗

**UI 按鈕功能**：
- 控制切換：在 P1、P2、P3 之間切換
- 新單位：為當前群組添加新單位
- PVP 開關：控制是否允許單位間戰鬥
- 顯示選項：開關各種視覺化輔助

## 設計特色

### 1. 架構優勢

- **模組化設計**：每個功能獨立成檔案，便於維護和擴展
- **即時演算**：所有行為都是即時計算，無預設路徑
- **視覺化除錯**：豐富的視覺化選項幫助理解算法運作

### 2. 技術特點

- **混合架構**：雖有 TypeScript 配置痕跡，但實際使用純 JavaScript，簡化部署流程
- **無需構建**：直接在瀏覽器中運行，降低使用門檻
- **CDN 載入**：p5.js 從 CDN 載入，減少專案體積

### 3. 擴展性

- 易於添加新的單位類型和行為
- 可自定義障礙物佈局
- 支援調整各種參數（速度、力度權重等）

## 應用場景

這個專案適合用於：

1. **教育用途**：演示群體 AI 和路徑規劃算法
2. **遊戲原型**：作為即時戰略遊戲的基礎框架
3. **算法研究**：測試和優化群聚行為參數
4. **視覺化展示**：展示複雜系統的湧現行為

## 技術債務與改進空間

1. **TypeScript 整合**：目前有 TypeScript 依賴但未實際使用
2. **性能優化**：大量單位時可能需要空間分割優化
3. **功能擴展**：可加入更多單位類型、地形系統等
4. **測試覆蓋**：缺少自動化測試

## 總結

這是一個設計良好的群體行為模擬專案，展示了如何用簡潔的代碼實現複雜的群體 AI 行為。專案結構清晰，易於理解和修改，非常適合作為學習群體 AI 和 p5.js 的範例專案。